:- use_module(scenario_manager).
:- dynamic test_passed/1.
:- dynamic test_failed/2.

run_dynamic_suite :-
    retractall(test_passed(_)),
    retractall(test_failed(_, _)),
    writeln('--- STARTING DYNAMIC VALIDATION ---'),
    test_file('./testsets/26usc469.pl', 'tax_code_section_469', '26USC469', 1),
    test_file('./testsets/26usc469_real_estate_exemption.pl', 'section_469_c7_professional_threshold', '26USC469_REAL_ESTATE_EXEMPTION', 2),
    test_file('./testsets/ai_evaluators_matching.pl', 'ai_evaluators_matching', 'AI_EVALUATORS_MATCHING', 3),
    test_file('./testsets/automatic_enrollment_defaults.pl', 'automatic_enrollment_defaults', 'AUTOMATIC_ENROLLMENT_DEFAULTS', 4),
    test_file('./testsets/biological_curiosity.pl', 'biological_curiosity', 'BIOLOGICAL_CURIOSITY', 5),
    test_file('./testsets/blackstone_carried_interest_taxation.pl', 'blackstone_ipo_restructuring', 'BLACKSTONE_CARRIED_INTEREST_TAXATION', 6),
    test_file('./testsets/blackstone_conflicts_of_interest.pl', 'blackstone_conflict_era', 'BLACKSTONE_CONFLICTS_OF_INTEREST', 7),
    test_file('./testsets/blackstone_smd_control.pl', 'blackstone_governance_lock', 'BLACKSTONE_SMD_CONTROL', 8),
    test_file('./testsets/blackstone_tax_receiveable_agreement.pl', 'blackstone_tra_life', 'BLACKSTONE_TAX_RECEIVEABLE_AGREEMENT', 9),
    test_file('./testsets/choice_architecture_design.pl', 'choice_architecture_design', 'CHOICE_ARCHITECTURE_DESIGN', 10),
    test_file('./testsets/cloudflare_dual_class_asymmetry.pl', 'cloudflare_dual_class_asymmetry', 'CLOUDFLARE_DUAL_CLASS_ASYMMETRY', 11),
    test_file('./testsets/coinbase_crypto_volatility.pl', 'coinbase_ipo_window', 'COINBASE_CRYPTO_VOLATILITY', 12),
    test_file('./testsets/coinbase_regulatory_uncertainty.pl', 'coinbase_reg_pivot', 'COINBASE_REGULATORY_UNCERTAINTY', 13),
    test_file('./testsets/college_admissions_market.pl', 'college_admissions_market', 'COLLEGE_ADMISSIONS_MARKET', 14),
    test_file('./testsets/columbia_2026_elections.pl', 'colombia_2026_presidential_election', 'COLUMBIA_2026_ELECTIONS', 15),
    test_file('./testsets/copyleft_viral_licensing.pl', 'copyleft_viral_licensing', 'COPYLEFT_VIRAL_LICENSING', 16),
    test_file('./testsets/copyright_protection.pl', 'copyright_protection', 'COPYRIGHT_PROTECTION', 17),
    test_file('./testsets/couples_residency_match.pl', 'couples_residency_match', 'COUPLES_RESIDENCY_MATCH', 18),
    test_file('./testsets/creative_commons_licensing.pl', 'creative_commons_licensing', 'CREATIVE_COMMONS_LICENSING', 19),
    test_file('./testsets/dark_patterns_manipulation.pl', 'dark_patterns_manipulation', 'DARK_PATTERNS_MANIPULATION', 20),
    test_file('./testsets/ergo_advanced_mechanisms.pl', 'storage_rent_interval', 'ERGO_ADVANCED_MECHANISMS', 21),
    test_file('./testsets/ergo_autolykos_asic_resistance.pl', 'ergo_mining_era', 'ERGO_AUTOLYKOS_ASIC_RESISTANCE', 22),
    test_file('./testsets/ergo_dexy_gold_protocol.pl', 'dexy_gold_interval', 'ERGO_DEXY_GOLD_PROTOCOL', 23),
    test_file('./testsets/ergo_lets_protocol.pl', 'ergo_lets_interval', 'ERGO_LETS_PROTOCOL', 24),
    test_file('./testsets/ergo_mixer_protocol.pl', 'ergo_mixer_interval', 'ERGO_MIXER_PROTOCOL', 25),
    test_file('./testsets/ergo_nipopows.pl', 'ergo_nipopows_interval', 'ERGO_NIPOPOWS', 26),
    test_file('./testsets/ergo_rosen_bridge_protocol.pl', 'rosen_bridge_interval', 'ERGO_ROSEN_BRIDGE_PROTOCOL', 27),
    test_file('./testsets/ergo_sig_usd_protocol.pl', 'sig_usd_interval', 'ERGO_SIG_USD_PROTOCOL', 28),
    test_file('./testsets/ergo_storage_rent_mechanism.pl', 'ergo_operational_era', 'ERGO_STORAGE_RENT_MECHANISM', 29),
    test_file('./testsets/exploration_vs_exploitation.pl', 'exploration_vs_exploitation', 'EXPLORATION_VS_EXPLOITATION', 30),
    test_file('./testsets/fair_use_doctrine.pl', 'fair_use_doctrine', 'FAIR_USE_DOCTRINE', 31),
    test_file('./testsets/gale_shapley.pl', 'gale_shapley_matching', 'GALE_SHAPLEY', 32),
    test_file('./testsets/genetic_algorithms_evolution.pl', 'genetic_algorithms_evolution', 'GENETIC_ALGORITHMS_EVOLUTION', 33),
    test_file('./testsets/gita_kurukshetra.pl', 'dharma_of_kurukshetra', 'GITA_KURUKSHETRA', 34),
    test_file('./testsets/golden_handcuffs.pl', 'golden_handcuffs', 'GOLDEN_HANDCUFFS', 35),
    test_file('./testsets/hamiltonian_path_complexity.pl', 'hamiltonian_path_complexity', 'HAMILTONIAN_PATH_COMPLEXITY', 36),
    test_file('./testsets/hammurabi.pl', 'hammurabi_lex_talionis', 'HAMMURABI', 37),
    test_file('./testsets/heuristic_optimization.pl', 'heuristic_optimization', 'HEURISTIC_OPTIMIZATION', 38),
    test_file('./testsets/information_foraging_theory.pl', 'information_foraging_theory', 'INFORMATION_FORAGING_THEORY', 39),
    test_file('./testsets/institutional_mutation_domestication.pl', 'institutional_mutation_domestication', 'INSTITUTIONAL_MUTATION_DOMESTICATION', 40),
    test_file('./testsets/kidney_exchange_market.pl', 'kidney_exchange_market', 'KIDNEY_EXCHANGE_MARKET', 41),
    test_file('./testsets/kjv_great_awakening.pl', 'great_awakening_rekindling', 'KJV_GREAT_AWAKENING', 42),
    test_file('./testsets/kjv_linguistic_residue.pl', 'kjv_linguistic_residue', 'KJV_LINGUISTIC_RESIDUE', 43),
    test_file('./testsets/kjv_puritan_new_world_exit.pl', 'puritan_new_world_pivot', 'KJV_PURITAN_NEW_WORLD_EXIT', 44),
    test_file('./testsets/kjv_textual_authority.pl', 'kjv_textual_authority', 'KJV_TEXTUAL_AUTHORITY', 45),
    test_file('./testsets/lehman_repo_105.pl', 'lehman_repo_105', 'LEHMAN_REPO_105', 46),
    test_file('./testsets/local_vs_global_optima.pl', 'local_vs_global_optima', 'LOCAL_VS_GLOBAL_OPTIMA', 47),
    test_file('./testsets/marriage_problem.pl', 'optimal_stopping_marriage', 'MARRIAGE_PROBLEM', 48),
    test_file('./testsets/matching_markets_general.pl', 'matching_markets_general', 'MATCHING_MARKETS_GENERAL', 49),
    test_file('./testsets/max_flow.pl', 'max_flow_min_cut', 'MAX_FLOW', 50),
    test_file('./testsets/medical_residency_match.pl', 'medical_residency_match', 'MEDICAL_RESIDENCY_MATCH', 51),
    test_file('./testsets/medieval_church_hegomony.pl', 'medieval_church_hegemony', 'MEDIEVAL_CHURCH_HEGOMONY', 52),
    test_file('./testsets/non_compete_agreements.pl', 'non_compete_agreements', 'NON_COMPETE_AGREEMENTS', 53),
    test_file('./testsets/permissive_software_licensing.pl', 'permissive_software_licensing', 'PERMISSIVE_SOFTWARE_LICENSING', 54),
    test_file('./testsets/public_domain_commons.pl', 'public_domain_commons', 'PUBLIC_DOMAIN_COMMONS', 55),
    test_file('./testsets/relativity_of_simultaneity.pl', 'relativity_of_simultaneity', 'RELATIVITY_OF_SIMULTANEITY', 56),
    test_file('./testsets/relativity_physical_invariance.pl', 'relativity_physical_invariance', 'RELATIVITY_PHYSICAL_INVARIANCE', 57),
    test_file('./testsets/rfc9293_interoperability.pl', 'tcp_rfc9293_interoperability', 'RFC9293_INTEROPERABILITY', 58),
    test_file('./testsets/rfc9293_state_machine.pl', 'tcp_state_machine_logic', 'RFC9293_STATE_MACHINE', 59),
    test_file('./testsets/rotation_seven_black_soil.pl', 'black_soil_toxicity', 'ROTATION_SEVEN_BLACK_SOIL', 60),
    test_file('./testsets/rotation_seven_isolation.pl', 'protocol_r7_isolation', 'ROTATION_SEVEN_ISOLATION', 61),
    test_file('./testsets/rotation_seven_kubo_ranking.pl', 'kubo_ranking_system_r7', 'ROTATION_SEVEN_KUBO_RANKING', 62),
    test_file('./testsets/s1_airbnb.pl', 'airbnb_ipo_era', 'S1_AIRBNB', 63),
    test_file('./testsets/s1_visa.pl', 'visa_ipo_window', 'S1_VISA', 64),
    test_file('./testsets/s1_visa_judgment_sharing_agreement.pl', 'visa_litigation_ringfencing', 'S1_VISA_JUDGMENT_SHARING_AGREEMENT', 65),
    test_file('./testsets/shannon_entropy_limit.pl', 'shannon_entropy_limit', 'SHANNON_ENTROPY_LIMIT', 66),
    test_file('./testsets/silicon_lexicon_overload.pl', 'silicon_lexicon_overload', 'SILICON_LEXICON_OVERLOAD', 67),
    test_file('./testsets/skills_based_hiring.pl', 'skills_based_hiring', 'SKILLS_BASED_HIRING', 68),
    test_file('./testsets/sludge_bureaucratic_friction.pl', 'sludge_bureaucratic_friction', 'SLUDGE_BUREAUCRATIC_FRICTION', 69),
    test_file('./testsets/sts86_ascent_checklist.pl', 'sts86_ascent_checklist', 'STS86_ASCENT_CHECKLIST', 70),
    test_file('./testsets/trade_secret_law.pl', 'trade_secret_law', 'TRADE_SECRET_LAW', 71),
    test_file('./testsets/traveling_salesperson_problem.pl', 'traveling_salesperson_problem', 'TRAVELING_SALESPERSON_PROBLEM', 72),
    count_and_report.

test_file(Path, ID, Label, N) :-
    format('~n[~w] DOMAIN: ~w (~w)~n', [N, Label, Path]),
    (   catch(load_and_run(Path, ID), E, (assertz(test_failed(Path, E)), format('[FAIL] Exception: ~w~n', [E]), fail))
    ->  assertz(test_passed(Path)),
        report_generator:generate_llm_feedback(ID)
    ;   assertz(test_failed(Path, audit_failed)),
        report_generator:generate_llm_feedback(ID)
    ),
    !. 

count_and_report :-
    findall(P, test_passed(P), Ps), length(Ps, PC), findall(F, test_failed(F,_), Fs), length(Fs, FC),
    format('~nDONE: ~w Passed, ~w Failed~n', [PC, FC]).
